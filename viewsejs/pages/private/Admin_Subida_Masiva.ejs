<!DOCTYPE html>
<html lang="es-cl">

<head>
    <%- include('../../modulos/head.ejs'); %>
    <meta name="description" content="Cibervoluntarios de DUOC UC">
    <meta name="author" content="Tecbit">
    <link href="/css/subida_masiva.css" rel="stylesheet">
    <link href="/css/modal.css" rel="stylesheet">

    <title>Cibervoluntarios</title>

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">
        <%- include('../../modulos/slidebar.ejs'); %>

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">
                <%- include('../../modulos/navbar.ejs'); %>
                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="row">
                        <!-- Earnings (Monthly) Card Example -->
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Descargar Plantilla</div>
                                            <div class="h6 font-weight text-gray-800 mb-1">Debe utilizar este formato para la carga masiva.</div>
                                            <button type="button" class="btn btn-success" id="downloadBtn">
                                                <i class="fas fa-cloud-download-alt mr-2"></i>Descargar plantilla
                                            </button>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-file-excel fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tasks Card Example -->
                        <div class="col-xl-6 col-md-6 mb-4">
                            <div class="card border-left-info shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                                Administrando sede:
                                            </div>
                                            <div class="row no-gutters align-items-center">
                                                <div class="card-body">
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                        <select class="custom-select" id="sedeSelector" <% if (Usuario.rol !== 1) { %> disabled <% } %>>
                                                            <% Sedes.forEach(function(sede) { %>
                                                            <option value="<%= sede.cod_sede %>" <% if (sede.cod_sede === SedeSeleccionada) { %> selected <% } %>>
                                                                <%= sede.sede %>
                                                            </option>
                                                            <% }); %>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-school fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Requests Card Example -->
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-warning shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Cantidad de usuarios actuales</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800"><%=Usuarios.length%> Usuarios registrados</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-users fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Row -->
                    <!-- Content Row -->
                    <div class="container mt-5">
        <div class="row">
            <div class="col-xl col-lg-7">
                <div class="drag-drop-area" id="dragDropArea">
                    <i class="fas fa-file-excel file-icon"></i>
                    <h5 class="mb-3">Arrastra y suelta archivos Excel aquí</h5>
                    <p class="upload-text mb-3">o haz clic para seleccionar archivos</p>
                    <small class="text-muted">Solo archivos .xls y .xlsx (máximo 10MB)</small>
                    <button type="button" class="btn btn-primary upload-button">
                        <i class="fas fa-upload mr-2"></i>Seleccionar Archivos
                    </button>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept=".xls,.xlsx" multiple>
                
                <div class="file-list" id="fileList"></div>
                
                <div class="mt-3" id="uploadSection" style="display: none;">
                    <button type="button" class="btn btn-success" id="uploadBtn">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>Subir Archivos
                    </button>
                    <button type="button" class="btn btn-secondary ml-2" id="clearBtn">
                        <i class="fas fa-trash mr-2"></i>Limpiar Todo
                    </button>
                </div>
            </div>
        </div>
    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <%- include('../../modulos/footer.ejs'); %>

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    
    
    <%- include('../../modulos/scripts_globales.ejs'); %>



    <script>
        const downloadBtn   = document.getElementById('downloadBtn');

        function parseFilename(headers, fallback){
            const cd = headers.get('Content-Disposition') || '';
            const m = cd.match(/filename\*?=(?:UTF-8'')?["']?([^"';]+)["']?/i);
            return m && m[1] ? decodeURIComponent(m[1]) : fallback;
        }

        function progressHTML(pctText='0%'){
            return `
            <div class="dl-row">
                <div class="dl-icon">
                <svg viewBox="0 0 24 24" width="26" height="26" aria-hidden="true">
                    <path d="M12 3v10m0 0l4-4m-4 4l-4-4M5 21h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                </div>
                <div>
                <div class="dl-sub">Generando Excel de usuarios activos…</div>
                </div>
            </div>
            <div class="dl-bar mt-3" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <div class="dl-fill" id="dlFill"></div>
            </div>
            <div class="dl-meta"><small>Progreso</small><small id="dlPct">${pctText}</small></div>
            `;
        }

        function successHTML(){
            return `
            <div class="dl-success">
                <div class="dl-check"><i class="fas fa-check"></i></div>
                <h5 class="mb-1">¡Listo!</h5>
                <div class="dl-sub">Archivo descargado correctamente</div>
            </div>
            `;
        }

        function setProgress(p){
            const pct = Math.max(0, Math.min(100, p|0));
            const fill = document.getElementById('dlFill');
            const pctEl = document.getElementById('dlPct');
            if (fill) fill.style.width = pct + '%';
            if (pctEl) pctEl.textContent = pct + '%';
            const bar = document.querySelector('.dl-bar');
            if (bar) bar.setAttribute('aria-valuenow', pct);
        }

        async function downloadUsersExcel(){
            const url  = `/plantillas/CargaUsuarios.xlsx`;

            await Swal.fire({
            title: 'Descargando',
            html: progressHTML('0%'),
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            customClass: { popup:'dl-popup', title:'dl-title' },
            didOpen: async () => {
                try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('No se pudo generar el Excel');

                const total = Number(resp.headers.get('Content-Length')) || 0;
                const filename = parseFilename(resp.headers, `Plantilla_Subida_Masiva.xlsx`);

                let indeterminateTimer = null;
                if (!total) {
                    let dir = 1, fake = 10;
                    indeterminateTimer = setInterval(() => {
                    fake += 3 * dir;
                    if (fake >= 92 || fake <= 8) dir *= -1;
                    setProgress(fake);
                    }, 90);
                }

                const reader = resp.body.getReader();
                const chunks = [];
                let received = 0;

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    received += value.length;
                    if (total) setProgress((received / total) * 100);
                }

                if (indeterminateTimer) clearInterval(indeterminateTimer);
                setProgress(100);

                const blob = new Blob(chunks, {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(a.href);

                await Swal.update({ title: ' ', html: successHTML() });
                setTimeout(() => Swal.close(), 900);
                } catch (err) {
                console.error(err);
                Swal.update({
                    icon: 'error',
                    title: 'Error',
                    html: '<div class="dl-sub">No se pudo descargar el archivo. Intenta nuevamente.</div>',
                    showConfirmButton: true,
                    confirmButtonText: 'Cerrar'
                });
                }
            }
            });
        }

        downloadBtn.addEventListener('click', downloadUsersExcel);
        </script>



     <script>
        $(document).ready(function() {
            const dragDropArea = $('#dragDropArea');
            const fileInput = $('#fileInput');
            const fileList = $('#fileList');
            const uploadSection = $('#uploadSection');
            let selectedFiles = [];

            // Click to select files
            dragDropArea.on('click', function() {
                fileInput.click();
            });

            $('.upload-button').on('click', function(e) {
                e.stopPropagation();
                fileInput.click();
            });

            // File input change
            fileInput.on('change', function() {
                handleFiles(this.files);
            });

            // Drag and drop events
            dragDropArea.on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });

            dragDropArea.on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
            });

            dragDropArea.on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
                const files = e.originalEvent.dataTransfer.files;
                handleFiles(files);
            });

            // Handle files
            function handleFiles(files) {
                Array.from(files).forEach(file => {
                    if (validateFile(file)) {
                        selectedFiles.push(file);
                        addFileToList(file);
                    }
                });
                updateUploadSection();
            }

            // Validate file
            function validateFile(file) {
                const validTypes = ['application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                const validExtensions = ['.xls', '.xlsx'];
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!validTypes.includes(file.type) && !validExtensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
                    alert('Por favor, selecciona solo archivos Excel (.xls, .xlsx)');
                    return false;
                }

                if (file.size > maxSize) {
                    alert('El archivo es demasiado grande. Máximo 10MB permitido.');
                    return false;
                }

                // Check if file already exists
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    alert('Este archivo ya ha sido seleccionado.');
                    return false;
                }

                return true;
            }

            // Add file to list
            function addFileToList(file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                const fileItem = $(`
                    <div class="file-item" data-filename="${file.name}">
                        <div class="file-info">
                            <i class="fas fa-file-excel"></i>
                            <div>
                                <strong>${file.name}</strong><br>
                                <small class="text-muted">${fileSize} MB</small>
                            </div>
                        </div>
                        <i class="fas fa-times remove-file" title="Eliminar archivo"></i>
                    </div>
                `);
                
                fileList.append(fileItem);
            }

            // Remove file
            fileList.on('click', '.remove-file', function() {
                const filename = $(this).closest('.file-item').data('filename');
                selectedFiles = selectedFiles.filter(file => file.name !== filename);
                $(this).closest('.file-item').remove();
                updateUploadSection();
            });

            // Update upload section visibility
            function updateUploadSection() {
                if (selectedFiles.length > 0) {
                    uploadSection.show();
                } else {
                    uploadSection.hide();
                }
            }

            // Upload files
            $('#uploadBtn').on('click', function() {
                if (selectedFiles.length === 0) {
                    alert('No hay archivos para subir.');
                    return;
                }

                // Here you would typically upload files to your server
                // For demo purposes, we'll just show a success message
                const formData = new FormData();
                selectedFiles.forEach((file, index) => {
                    formData.append(`file_${index}`, file);
                });

                // Simulate upload process
                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Subiendo...');
                
                setTimeout(() => {
                    alert(`${selectedFiles.length} archivo(s) subido(s) exitosamente!`);
                    clearAll();
                    $(this).prop('disabled', false).html('<i class="fas fa-cloud-upload-alt mr-2"></i>Subir Archivos');
                }, 2000);
            });

            // Clear all files
            $('#clearBtn').on('click', function() {
                clearAll();
            });

            function clearAll() {
                selectedFiles = [];
                fileList.empty();
                fileInput.val('');
                updateUploadSection();
            }
        });
    </script>
    <script>
        document.getElementById('sedeSelector').addEventListener('change', function () {
            const selectedSede = this.value;
            const url = new URL(window.location.href);
            url.searchParams.set('sede', selectedSede);
            window.location.href = url.toString();
        });
    </script>

</body>

</html>